<!DOCTYPE html>
<meta charset="utf-8">
<head>

	<title>Project 3</title>

	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

</head>

<body>

	<h1 id="title"> Space X Missions</h1>
	<div id="submenu">
		<button type="submit" style="border: 0; background: transparent" onclick="sort(0);">
			<img src="icons/button1.png" width="200" height="80" alt="submit" />
		</button>
		<button type="submit" style="border: 0; background: transparent" onclick="sort(1);">
			<img src="icons/button2.png" width="200" height="80" alt="submit" />
		</button>
		<button type="submit" style="border: 0; background: transparent" onclick="sort(2);">
			<img src="icons/button3.png" width="200" height="80" alt="submit" />
		</button>
		<button type="submit" style="border: 0; background: transparent" onclick="sort(3);">
			<img src="icons/button4.png" width="200" height="80" alt="submit" />
		</button>
	</div>

	<div class="svg-container">
		<svg id="globe" class="globe"> </svg>
		<svg id="missionOutcome" height = "300" width="300"></svg>
	</div>

	<script>

		var missions_set = [];
		var launchlocations = [];
		var arcs;
		var launchColor;
		var blink = false;
		var locNames = ["Cape Canaveral AFS LC-40", "Marshall Islands", "Vandenberg AFB SLC-4E", "Kennedy Space Center LC-39A"];

		class mission {
			constructor( day, month, year, loc, site, type, orbit, costumer, country, costumer_type, outcome, reason ) {
				this.day = day;
				this.month = month;
				this.year = year;
				this.loc = loc;
				this.site = site;
				this.type = type;
				this.orbit = orbit;
				this.costumer = costumer;
				this.country = country;
				this.costumer_type = costumer_type;
				this.outcome = outcome;
				this.reason = reason;
			}
		};

		d3.queue()
		.defer(d3.csv, "datasets/missions.csv")
		.defer(d3.csv, "datasets/launch-sites.csv")
		.await(function (error, rawMissions, launchdata) {

			launchdata.forEach(function(d){

				var orientation = d.Longitude.split(" ")[1];

				if(orientation == 'W'){
					d.Longitude = Number(d.Longitude.split(" ")[0]) * -1;
				} else{
					d.Longitude = Number(d.Longitude.split(" ")[0]);
				}
				d.Latitude = Number(d.Latitude.split(" ")[0]);

				launchlocations.push([d.Longitude, d.Latitude, d["Launch Site"]]);

			});

			rawMissions.forEach(function(element) {

				var new_mission = new mission(
					element.Day,
					element.Month,
					element.Year,
					0,
					element["Launch Site"],
					element["Payload Type"],
					element["Payload Orbit"],
					element["Customer Name"],
					element["Customer Country"],
					element["Customer Type"],
					element["Mission Outcome"],
					element["Failure Reason"]
					);

				launchdata.forEach(function(site) {
					if(site["Launch Site"] == new_mission.site){
						new_mission.loc = [site.Longitude, site.Latitude];
					}
				});
				missions_set.push(new_mission);
			});

			showMap();
			showLocations(launchlocations);
			//showSiteInfo();

		});


		function sort(index){

			var filtered_missions = [];


			missions_set.forEach(function(element){

				if(element.site == locNames[index]){
					filtered_missions.push(element);
				}

			});
			
			showLaunches(filtered_missions);
			animateLaunch();
			showSiteInfo(filtered_missions);
		};

	  // draw the us map using the json
	  function showMap() {

	  	var width = 600,
	  	height = 600;

	  	projection = d3.geoOrthographic()
	  	.scale(300)
	  	.rotate([100, -40, 0])
	  	.translate([width / 2, height / 2])
	  	.clipAngle(90)
	  	.precision(.1);

	  	var path = d3.geoPath()
	  	.projection(projection);

	  	var graticule = d3.geoGraticule();

	  	var svg = d3.select("#globe")
	  	.attr("width", width)
	  	.attr("height", height);

	  	svg.append("defs").append("path")
	  	.datum({type: "Sphere"})
	  	.attr("id", "sphere")
	  	.attr("d", path);

	  	svg.append("use")
	  	.attr("class", "stroke")
	  	.attr("xlink:href", "#sphere");

	  	svg.append("use")
	  	.attr("class", "fill")
	  	.attr("xlink:href", "#sphere");

	  	svg.append("path")
	  	.datum(graticule)
	  	.attr("class", "graticule")
	  	.attr("d", path);

	  	arcs = svg.selectAll("path.arcs");

	  	d3.json("world-50m.json", function(error, world) {
	  		if (error) throw error;

	  		svg.insert("path", ".graticule")
	  		.datum(topojson.feature(world, world.objects.land))
	  		.attr("class", "land")
	  		.attr("d", path);

	  		svg.insert("path", ".graticule")
	  		.datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
	  		.attr("class", "boundary")
	  		.attr("d", path);
	  	});

	  	d3.select(self.frameElement).style("height", height + "px");

	  };

	  function showLocations(points){

	  	var circles = d3.select("#globe").selectAll("circle").data(points);
	  	var randomNum = function(){
	  		return Math.random()*20;
	  	};

	  	circles.exit().remove();

	  	circles.enter().append("circle").attr("r", 5).attr("fill", "#E3E3E3")
	  	.merge(circles)
	  	.attr("cx", function(d) { return projection(d)[0]; })
	  	.attr("cy", function(d) { return projection(d)[1]; });

	  	circles.enter().append("text").text(function(d) { return d[2]; })
	  	.attr("fill", "#E3E3E3")
	  	.merge(circles)
	  	.attr("x", function(d) { return projection(d)[0] + 5; })
	  	.attr("y", function(d) { return projection(d)[1] - randomNum(); });

	  };


	  function showLaunches(filtered_missions){

	  	var svg = d3.select("#globe");

			arcs.exit().remove();
			d3.selectAll(".arcs").remove();

			arcs.data(filtered_missions)
			.enter()
			.append("path")
			.style("opacity", "0")
			.style("pointer-events", "all")
			.attr("id" , function(d,i){
				return "line" + i;
			})
			.attr("class", "arcs")
			.attr('d', function(d) {
				return lngLatToArc(d, d["loc"], [-100.751114, 147.349442], 0)
			})
			.style("stroke", "#ff9a00")

			d3.selectAll(".arcs").style("opacity", "0.5");

			d3.selectAll(".arcs").each(function(d,i){

				var totalLength = d3.select("#line" + i).node().getTotalLength();

				d3.selectAll("#line" + i)
				.attr("stroke-dasharray", totalLength + " " + totalLength)
				.attr("stroke-dashoffset", totalLength)
				.transition()
				.duration(10000)
				.attr("stroke-dashoffset", 0);

			});

			// launchColor = setInterval(animate, 100);

			
		};

		function animate(){

			if(blink == false){
				d3.select("#globe").selectAll(".arcs")
				.style("stroke","#E3E3E3")
				.style("opacity" , "0.2")
				blink = true;

			}else{
				d3.select("#globe").selectAll(".arcs")
				.style("stroke","#E3E3E3")
				.style("opacity" , "1")
				blink = false;
			};

		};

		// Creates animated planes flying above the routes on a day
		function animateLaunch(){

			var svg = d3.select("#globe");
			var delay = 0;

			function transition(plane, route) {
				var l = route.node().getTotalLength();
				plane.transition()
				.duration(9500 + delay)
				.attrTween("transform", delta(route.node()));
			};

			function delta(path) {
				var l = path.getTotalLength();
				return function(i) {
					return function(t) {
						var p = path.getPointAtLength(t *  l);
						var t2 = Math.min(t + 0.05, 1);
						var p2 = path.getPointAtLength(t2 * l);

						var x = p2.x - p.x;
						var y = p2.y - p.y;
						var r = 90 - Math.atan2(-y, x) * 180 / Math.PI;

						var s = Math.min(Math.sin(Math.PI * t) * 0.7, 0.3);
						return "translate(" + (p.x - 8) + "," + p.y + ") scale(" + s + ") rotate(" + r + ")";
					};
				};
			};

			d3.selectAll(".arcs").each(function(d,i){

				var type = d["type"]

				var rocket = svg.append("svg:image")
				.attr("class", "rocket")
				.attr("width","10%")
				.attr("height","10%")
				.attr("fill","white")
				.attr("xlink:href", function(d){

					if(type == "Human Remains"){
						return "icons/remains.png"
					}else if(type== "Space Station Supplies"){
						return "icons/supplies.png"
					}else{
						return "icons/satellite.png"
					}

				});

				var trajectory = d3.select("#line" + i);

				transition(rocket, trajectory, delay);

				delay += 2000;

			});
		};

		// Converts lontitude and lattitude to an arc on which the flight path is drawn
		function lngLatToArc(d, sourceLngLat, targetLngLat, bend){

			bend = bend || 1;

			if (targetLngLat && sourceLngLat) {
				var sourceXY = projection( sourceLngLat ),
				targetXY = projection( targetLngLat );

				if (!targetXY) { console.log(d, targetLngLat, targetXY)}
					var sourceX = sourceXY[0],
				sourceY = sourceXY[1];

				var targetX = targetXY[0],
				targetY = targetXY[1];

				var dx = targetX - sourceX,
				dy = targetY - sourceY,
				dr = Math.sqrt(dx * dx + dy * dy)*bend;

				var west_of_source = (targetX - sourceX) < 0;
				if (west_of_source) return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;
				return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;

			} else {
				return "M0,0,l0,0z";
			};
		};

		//pie charts for launch site data visualization
		function showSiteInfo(data){
			var outcomeSVG = d3.select("#missionOutcome");
			 	width = +outcomeSVG.attr("width"),
     			height = +outcomeSVG.attr("height"),
     			radius = Math.min(width, height) / 2,
     			g = outcomeSVG.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

			 var color = d3.scaleOrdinal(["#98abc5", "#8a89a6"]);
			
			 var outcomePieData = [{"label":"Success", "value":0}, 
		          {"label":"Failure", "value":0}]
			 
			 data.forEach(function(d){
			 	if(d.outcome == "Failure"){
			 		outcomePieData[1].value +=1;
			 	}
			 	else{
			 		outcomePieData[0].value +=1;
			 	}
			 });

			console.log(outcomePieData);
			  	var pie = d3.pie()
     					.sort(null)
    					.value(function(d) { return d.value; });

				var path = d3.arc()
    					.outerRadius(radius - 10)
    					.innerRadius(0);

				var label = d3.arc()
   						.outerRadius(radius - 40)
    					.innerRadius(radius - 40);

    			var arc = g.selectAll(".arc")
    					.data(pie(outcomePieData))
    					.enter().append("g")
    							.attr("class", "arc");

    			arc.append("path")
    				.attr("d", path)
    				.attr("fill", function(d){return color(d.data.label);});

    			arc.append("text")
     				.attr("transform", function(d) { return "translate(" + label.centroid(d) + ")"; })
      				.attr("dy", "0.35em")
      				.text(function(d) { return d.data.label+" " + d.data.value; });
	 		
    	}

	</script>

</body>

</html>
