<!DOCTYPE html>
<meta charset="utf-8">
<head>

	<title>Project 3</title>

	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

</head>

<body>
	<div id="modal">
		<h2 id="satelliteName"></h2>
		<h4 id="satelliteType"></h4>
		<p id="customerName"></p>
		<p id="countryName"></p>
		<p id="missionOutcome"></p>
		<p id="outcomeReason"></p>
		<p style="font-size: 20px"> <b>Click to Close.</b> </p>
	</div>
	<div id="modalContainer">

	<h1 id="title"> Space X Missions</h1>

	<div id="submenu">
		<h3>Launch Sites</h3>
		<button type="submit"  onclick="sort(0, 'btnImg');">
			<a href="#globe"><img class="btnImg"  src="imgs/button1.png" alt="submit" /></a>
		</button>
		<button type="submit" onclick="sort(1, 'btnImg');">
			<a href="#globe"><img class="btnImg"  src="imgs/button2.png" alt="submit" /></a>
		</button>
		<button type="submit" onclick="sort(2, 'btnImg');">
			<a href="#globe"><img class="btnImg" src="imgs/button3.png" alt="submit" /></a>
		</button>
		<button type="submit" onclick="sort(3, 'btnImg');">
			<a href="#globe"><img class="btnImg"  src="imgs/button4.png"  alt="submit" /></a>
		</button>
	</div>

	<div class="svg-container">
		<div class="orbit">
		<img src="imgs/legend.png" alt="legend" height="30" width="700"/>
		<br>
			<div class="orbitTitle">
				<h2>High Earth Orbit</h2>
			</div>
			<div class="satelliteImages" id="highEarthOrbit"></div>
		</div>
		<div class="orbit">
			<div class="orbitTitle">
				<h2>GPS Satellites</h2>
			</div>
			<div class="satelliteImages" id="gpsSatellites"></div>
		</div>
		<div class="orbit">
			<div class="orbitTitle">
				<h2>Medium Earth Orbit</h2>
			</div>
			<div class="satelliteImages" id="mediumEarthOrbit"></div>
		</div>
		<div class="orbit">
			<div class="orbitTitle">
				<h2>Low Earth Orbit</h2>
			</div>
			<div class="satelliteImages" id="lowEarthOrbit"></div>
		</div>
		<div class="orbit">
			<div class="orbitTitle">
				<h2>Sea level</h2>
			</div>
			<div class="satelliteImages" id="seaLevel"></div>
		</div>
		<div class="orbit">
			<div class="orbitTitle">
				<h2>Failed Missions</h2>
				<h5>(did not reach any orbit)</h5>
			</div>
			<div class="satelliteImages" id="failedMission"></div>
		</div>

		<svg id="globe" class="globe"> </svg>
		<br>
		<br>
		<p style="font-size: 26px"> Percentages Display for Mission Outcomes, Payload Type. </p>
		<svg id="missionOutcomeDisplay" height = "400" width="300"></svg>
		<svg id="payloadType" height = "400" width="300"></svg>
		<svg id="countryTypes" height = "400" width="300"></svg>
	</div>
</div>

	<script>

		var missions_set = [];
		var launchlocations = [];
		var launchColor;
		var locNames = ["Cape Canaveral AFS LC-40", "Marshall Islands", "Vandenberg AFB SLC-4E", "Kennedy Space Center LC-39A"];
		var arcs;
		var blink = false;

		var dismissModal = document.querySelector("#modal");

		dismissModal.onclick = function(){
			document.getElementById("modal").style.display = "none";
			document.getElementById("modalContainer").style.backgroundColor = "transparent";
			document.getElementById("modalContainer").style.opacity = 1;
		}

		function showSatelliteDetails(data){
			//customer, customer_type, Country, outcome, reason, type of satellite
			//data.costumer, data.costumer_type, data.country, data.outcome, data.reason, data.type
			console.log(data);
			data = data.split(',');
			//satelliteType, customerName, countryName, missionOutcome, outcomeReason
			document.getElementById("satelliteName").innerHTML = data[6];
			document.getElementById("satelliteType").innerHTML = data[5];
			document.getElementById("customerName").innerHTML = "Customer: "+data[0]+", "+data[1];
			document.getElementById("countryName").innerHTML = "Country: "+ data[2];
			document.getElementById("missionOutcome").innerHTML = data[3];
			document.getElementById("outcomeReason").innerHTML = data[4];
			document.getElementById("modal").style.display = "block";
			document.getElementById("modalContainer").style.backgroundColor = "grey";
			document.getElementById("modalContainer").style.opacity = 0.5;
		}
		

		class mission {
			constructor(day, month, year, name, loc, site, type, orbit, costumer, country, costumer_type, outcome, reason) {
				this.day = day;
				this.month = month;
				this.year = year;
				this.name = name;
				this.loc = loc;
				this.site = site;
				this.type = type;
				this.orbit = orbit;
				this.costumer = costumer;
				this.country = country;
				this.costumer_type = costumer_type;
				this.outcome = outcome;
				this.reason = reason;
			}
		};


		d3.queue()
		.defer(d3.csv, "datasets/missions.csv")
		.defer(d3.csv, "datasets/launch-sites.csv")
		.await(function (error, rawMissions, launchdata) {

			launchdata.forEach(function(d) {

				var orientation = d.Longitude.split(" ")[1];

				if(orientation == 'W'){
					d.Longitude = Number(d.Longitude.split(" ")[0]) * -1;
				}else{
					d.Longitude = Number(d.Longitude.split(" ")[0]);
				};

				d.Latitude = Number(d.Latitude.split(" ")[0]);

				launchlocations.push([d.Longitude, d.Latitude, d["Launch Site"]]);

			});

			rawMissions.forEach(function(element) {

				var new_mission = new mission(
					element.Day,
					element.Month,
					element.Year,
					element["Payload Name"],
					0,
					element["Launch Site"],
					element["Payload Type"],
					element["Payload Orbit"],
					element["Customer Name"],
					element["Customer Country"],
					element["Customer Type"],
					element["Mission Outcome"],
					element["Failure Reason"]
					);

				launchdata.forEach(function(site) {
					if(site["Launch Site"] == new_mission.site){
						new_mission.loc = [site.Longitude, site.Latitude];
					};
				});

				missions_set.push(new_mission);

			});

			showMap();
			showLocations(launchlocations);

		});

		function sort(index, btnelem) {
			var btn = document.getElementsByClassName(btnelem);

			for(var i=0; i<btn.length; i++){
				btn[i].classList.remove('selected-btn');
			};
			
			btn[index].classList.add('selected-btn');

			var filtered_missions = [];


			missions_set.forEach(function(element){

				if(element.site == locNames[index]){
					filtered_missions.push(element);
				};

			});
			
			showLaunches(filtered_missions);
			animateLaunch();
			outcomeInfo(filtered_missions);
			payloadInfo(filtered_missions);
			countryInfo(filtered_missions);
		};


		function showMap() {

			var width = 600,
			height = 600;

			projection = d3.geoOrthographic()
			.scale(300)
			.rotate([100, -40, 0])
			.translate([width / 2, height / 2])
			.clipAngle(90)
			.precision(.1);

			var path = d3.geoPath()
			.projection(projection);

			var graticule = d3.geoGraticule();

			var svg = d3.select("#globe")
			.attr("width", width)
			.attr("height", height);

			svg.append("defs").append("path")
			.datum({type: "Sphere"})
			.attr("id", "sphere")
			.attr("d", path);

			svg.append("use")
			.attr("class", "stroke")
			.attr("xlink:href", "#sphere");

			svg.append("use")
			.attr("class", "fill")
			.attr("xlink:href", "#sphere");

			svg.append("path")
			.datum(graticule)
			.attr("class", "graticule")
			.attr("d", path);

			arcs = svg.selectAll("path.arcs");

			d3.json("world-50m.json", function(error, world) {
				if (error) throw error;

				svg.insert("path", ".graticule")
				.datum(topojson.feature(world, world.objects.land))
				.attr("class", "land")
				.attr("d", path);

				svg.insert("path", ".graticule")
				.datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
				.attr("class", "boundary")
				.attr("d", path);
			});

			d3.select(self.frameElement).style("height", height + "px");

		};


		function showLocations(points) {

			var circles = d3.select("#globe").selectAll("circle")
			.data(points);

			var randomNum = function(){
				return Math.random()*20;
			};

			circles.exit().remove();

			circles.enter().append("circle")
			.attr("r", 5)
			.attr("fill", "#E3E3E3")
			.merge(circles)
			.attr("cx", function(d) { return projection(d)[0]; })
			.attr("cy", function(d) { return projection(d)[1]; });

			circles.enter().append("text")
			.text(function(d) { return d[2]; })
			.attr("fill", "#E3E3E3")
			.merge(circles)
			.attr("x", function(d) { return projection(d)[0] + 15; })
			.attr("y", function(d) { 

				if(d[2]=="Kennedy Space Center LC-39A"){
					return projection(d)[1] + 20;
				}else{
					return projection(d)[1] - randomNum();
				};
				
			});

		};


		function showLaunches(filtered_missions) {

			/*console.log(filtered_missions);*/

			var svg = d3.select("#globe");

			arcs.exit().remove();
			d3.selectAll(".arcs").remove();

			arcs.data(filtered_missions)
			.enter()
			.append("path")
			.style("opacity", "0")
			.style("pointer-events", "all")
			.attr("id" , function(d,i){
				return "line" + i;
			})
			.attr("class", "arcs")
			.attr('d', function(d) {
				return lngLatToArc(d, d["loc"], [-100.751114, 147.349442], 0)
			})
			.style("stroke", "#FFB270");

			// MAKE IT SO THEY GO OUT OF THE MAP

			d3.selectAll(".arcs").style("opacity", "0.5");

			d3.selectAll(".arcs").each(function(d,i){

				var totalLength = d3.select("#line" + i).node().getTotalLength();

				d3.selectAll("#line" + i)
				.attr("stroke-dasharray", totalLength + " " + totalLength)
				.attr("stroke-dashoffset", totalLength)
				.transition()
				.duration(10000)
				.attr("stroke-dashoffset", 0);

			});

			// launchColor = setInterval(animate, 100);
		};


		function animate() {

			if(blink == false){
				d3.select("#globe").selectAll(".arcs")
				.style("stroke","#E3E3E3")
				.style("opacity" , "0.2")
				blink = true;

			}else{
				d3.select("#globe").selectAll(".arcs")
				.style("stroke","#E3E3E3")
				.style("opacity" , "1")
				blink = false;
			};

		};


		function animateLaunch(){

			var svg = d3.select("#globe");
			var delay = 0;

			function transition(launch, route) {
				var l = route.node().getTotalLength();
				launch.transition()
				.duration(9500 + delay)
				.attrTween("transform", delta(route.node()));
			};

			function delta(path) {
				var l = path.getTotalLength();
				return function(i) {
					return function(t) {
						var p = path.getPointAtLength(t *  l);
						var t2 = Math.min(t + 0.05, 1);
						var p2 = path.getPointAtLength(t2 * l);

						var x = p2.x - p.x;
						var y = p2.y - p.y;
						var r = 90 - Math.atan2(-y, x) * 180 / Math.PI;

						var s = Math.min(Math.sin(Math.PI * t) * 0.7, 0.3);
						return "translate(" + (p.x - 10) + "," + p.y + ") scale(" + s + ") rotate(" + r + ")";
					};
				};
			};

			var failedMission = document.getElementById("failedMission");
			var highEarthOrbit = document.getElementById("highEarthOrbit");
			var gpsSatellites = document.getElementById("gpsSatellites");
			var mediumEarthOrbit = document.getElementById("mediumEarthOrbit");
			var lowEarthOrbit = document.getElementById("lowEarthOrbit");
			var seaLevel = document.getElementById("seaLevel");
			failedMission.innerHTML = "";
			highEarthOrbit.innerHTML = "";
			gpsSatellites.innerHTML = "";
			mediumEarthOrbit.innerHTML = "";
			lowEarthOrbit.innerHTML = "";
			seaLevel.innerHTML = "";

			function showSatellitesInOrbit(data, imageurl){
				//failedMission, highEarthOrbit, gpsSatellites, mediumEarthOrbit, lowEarthOrbit, seaLevel
				var img = document.createElement("img");
				img.src = imageurl;
				img.height = 40;
				img.width = 40;
				img.className = "orbit-satellite";

				if(data.orbit == "" || data.outcome == "Failure"){
					failedMission.appendChild(img);
					img.setAttribute("class", "orbit-satellite failure");
				}else{
					img.setAttribute("class", "orbit-satellite success");
				}
				if(data.orbit == "Polar Orbit" || data.orbit == "Sun/Earth Orbit"){
					seaLevel.appendChild(img);
				}
				if(data.orbit == "Low Earth Orbit"){
					lowEarthOrbit.appendChild(img);
				}
				if(data.orbit == "Geostationary Transfer Orbit"){
					gpsSatellites.appendChild(img);
				}
				img.setAttribute("onclick", "showSatelliteDetails("+"'"+[data.costumer, data.costumer_type, data.country, data.outcome, data.reason, data.type, data.name]+"'"+")");
			}


			d3.selectAll(".arcs").each(function(d,i){

				/*console.log(d);*/
				var satellitedata = d;
				var type = d["type"];
				var imgUrl = "";

				var rocket = svg.append("svg:image")
				.attr("class", "rocket")
				.attr("width","15%")
				.attr("height","15%")
				.attr("xlink:href", function(d){

					if(type == "Human Remains"){
						imgUrl = "imgs/remains.png";
					}else if(type== "Space Station Supplies"){
						imgUrl = "imgs/supplies.png";
					}else{
						imgUrl = "imgs/satellite.png";
					};
					showSatellitesInOrbit(satellitedata, imgUrl);
					return imgUrl;
				});

				var trajectory = d3.select("#line" + i);

				transition(rocket, trajectory, delay);

				delay += 2000;

			});
		};


		function lngLatToArc(d, sourceLngLat, targetLngLat, bend){

			bend = bend || 1;

			if (targetLngLat && sourceLngLat) {
				var sourceXY = projection( sourceLngLat ),
				targetXY = projection( targetLngLat );

				if (!targetXY) { console.log(d, targetLngLat, targetXY)}
					var sourceX = sourceXY[0],
				sourceY = sourceXY[1];

				var targetX = targetXY[0],
				targetY = targetXY[1];

				var dx = targetX - sourceX,
				dy = targetY - sourceY,
				dr = Math.sqrt(dx * dx + dy * dy)*bend;

				var west_of_source = (targetX - sourceX) < 0;
				if (west_of_source) return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;
				return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;

			} else {
				return "M0,0,l0,0z";
			};
		};
		

		function outcomeInfo(data){
			var outcomeSVG = d3.select("#missionOutcomeDisplay");
			outcomeSVG.selectAll("*").remove();
			width = +outcomeSVG.attr("width"),
			height = +outcomeSVG.attr("height"),
			radius = Math.min(width, height) / 2,
			g = outcomeSVG.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

			var color = d3.scaleOrdinal(["#BFF2E2", "#7FD3B9"]);
			
			var outcomePieData = [{"label":"Success", "value":0}, 
			{"label":"Failure", "value":0}]

			data.forEach(function(d){
				if(d.outcome == "Failure"){
					outcomePieData[1].value +=1;
				}
				else{
					outcomePieData[0].value +=1;
				}
			});

			var pie = d3.pie()
			.sort(null)
			.value(function(d) { return d.value; });

			var path = d3.arc()
			.outerRadius(radius - 10)
			.innerRadius(0);

			var label = d3.arc()
			.outerRadius(radius - 40)
			.innerRadius(radius - 40);

			var arc = g.selectAll(".arc")
			.data(pie(outcomePieData))
			.enter().append("g")
			.attr("class", "arc");

			arc.append("path")
			.attr("d", path)
			.attr("fill", function(d){return color(d.data.label);});

			arc.append("text")
			.attr("transform", function(d) { return "translate(" + label.centroid(d) + ")"; })
			.attr("dy", "0.35em")
			.attr("fill", "black")
			.text(function(d) { return d.data.label+" " + d.data.value; });

			outcomeSVG.append("text")
			.attr("x", 85)
			.attr("y", height-15)
			.text("Success and Failure Rate")
			.attr("fill", "white")
			.attr("font-size", "10pt")
			.attr("font-anchor", "middle");		
		}


		function payloadInfo(data){
			var payloadSVG = d3.select("#payloadType");
			payloadSVG.selectAll("*").remove();
			width = 300,
			height = 400,
			radius = 150,
			g = payloadSVG.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

			var color = d3.scaleOrdinal(["#E9FAF5", "#BFF2E2", "#95EACF", "#66A994", "#33554A"]);
			
			var payloadPieData = [];
			var researchValue=0;
			var communicationValue=0;
			var humanRemainValue=0;
			var suppliesValue=0;
			var weatherValue=0;
			data.forEach(function(d){
				if(d.type == "Research Satellite" || d.type == "Research Satellites" || d.type == "Communication/Research Satellite"){
					researchValue +=1;
				}
				else if(d.type == "Communication Satellite" || d.type == "Communication/Research Satellite"){
					communicationValue +=1;
				}
				else if(d.type == "Human Remains"){
					humanRemainValue+=1;
				}
				else if(d.type == "Weather Satellite"){
					weatherValue +=1;
				}
				else if(d.type == "Space Station Supplies"){
					suppliesValue +=1;
				}
			});

			if(researchValue != 0){
				var temp={"label":"Research", "value":researchValue};
				payloadPieData.push(temp);
			}
			if(communicationValue != 0){
				var temp={"label":"Communication", "value":communicationValue};
				payloadPieData.push(temp);
			}
			if(humanRemainValue != 0){
				var temp={"label":"Human Remains", "value":humanRemainValue};
				payloadPieData.push(temp);
			}
			if(suppliesValue != 0){
				var temp={"label":"Supplies", "value":suppliesValue};
				payloadPieData.push(temp);
			}
			if(weatherValue != 0){
				var temp={"label":"Weather", "value":weatherValue};
				payloadPieData.push(temp);
			}

			var pie = d3.pie()
			.sort(null)
			.value(function(d) { return d.value; });

			var path = d3.arc()
			.outerRadius(radius - 10)
			.innerRadius(0);

			var label = d3.arc()
			.outerRadius(radius - 40)
			.innerRadius(radius - 40);

			var arc = g.selectAll(".arc")
			.data(pie(payloadPieData))
			.enter().append("g")
			.attr("class", "arc");

			arc.append("path")
			.attr("d", path)
			.attr("fill", function(d){return color(d.data.label);});

			if(function(d){return d.data.value == 0}){
				console.log("returned true")
				arc.append("text")
				.attr("transform", function(d) { return "translate(" + label.centroid(d) + ")"; })
				.attr("dy", "1em")
				.attr("fill", "black")
				.text(function(d){return d.data.label+" " + d.data.value});
			};

			payloadSVG.append("text")
			.attr("x", 110)
			.attr("y", height-15)
			.text("Payload Types")
			.attr("fill", "white")
			.attr("font-size", "10pt")
			.attr("font-anchor", "middle");		
		}

		function countryInfo(data){
			var countrySVG = d3.select("#countryTypes");
			countrySVG.selectAll("*").remove();
			width = 300,
			height = 400,
			radius = 150,
			g = countrySVG.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

			var color = d3.scaleOrdinal(["#D4F6EC","#AAEED9", "#7FD3B9", "#4C7F6F","#33554A","#66A994","#95EACF","#BFF2E2", "#E9FAF5"]);
			
			var countryPieData = [];
			var USValue=0;
			var MalaysiaValue=0;
			var CanadaValue=0;
			var LuxembourgValue=0;
			var ThaiValue=0;
			var ChinaValue=0;
			var BermudaValue=0;
			var FranceValue=0;
			var TurkmenistanValue=0;
			var JapanValue=0;
			var IsraelValue=0;
			data.forEach(function(d){
				if(d.country == "United States"){
					USValue +=1;
				}
				else if(d.country == "Malaysia"){
					MalaysiaValue +=1;
				}
				else if(d.country == "Canada"){
					CanadaValue +=1;
				}
				else if(d.country == "Luxembourg"){
					LuxembourgValue +=1;
				}
				else if(d.country == "Thailand"){
					ThaiValue +=1;
				}
				else if(d.country == "China"){
					ChinaValue +=1;
				}
				else if(d.country == "Bermuda"){
					BermudaValue +=1;
				}
				else if(d.country == "France (Mexico)"){
					FranceValue +=1;
				}
				else if(d.country == "Turkmenistan"){
					TurkmenistanValue +=1;
				}
				else if(d.country == "Japan"){
					JapanValue +=1;
				}
				else if(d.country == "Israel"){
					IsraelValue +=1;
				}
			});

			if(USValue != 0){
				var temp={"label":"US", "value":USValue};
				countryPieData.push(temp);
			}
			if(MalaysiaValue != 0){
				var temp={"label":"Malaysia", "value":MalaysiaValue};
				countryPieData.push(temp);
			}
			if(CanadaValue != 0){
				var temp={"label":"Canada", "value":CanadaValue};
				countryPieData.push(temp);
			}
			if(LuxembourgValue != 0){
				var temp={"label":"Luxembourg", "value":LuxembourgValue};
				countryPieData.push(temp);
			}
			if(ThaiValue != 0){
				var temp={"label":"Thailand", "value":ThaiValue};
				countryPieData.push(temp);
			}
			if(ChinaValue != 0){
				var temp={"label":"China", "value":ChinaValue};
				countryPieData.push(temp);
			}
			if(BermudaValue != 0){
				var temp={"label":"Bermuda", "value":BermudaValue};
				countryPieData.push(temp);
			}
			if(FranceValue != 0){
				var temp={"label":"France", "value":FranceValue};
				countryPieData.push(temp);
			}
			if(TurkmenistanValue != 0){
				var temp={"label":"Turkmenistan", "value":TurkmenistanValue};
				countryPieData.push(temp);
			}
			if(JapanValue != 0){
				var temp={"label":"Japan", "value":JapanValue};
				countryPieData.push(temp);
			}
			if(IsraelValue != 0){
				var temp={"label":"Israel", "value":IsraelValue};
				countryPieData.push(temp);
			}

			console.log(countryPieData);

			var pie = d3.pie()
			.sort(null)
			.value(function(d) { return d.value; });

			var path = d3.arc()
			.outerRadius(radius - 10)
			.innerRadius(0);

			var label = d3.arc()
			.outerRadius(radius - 40)
			.innerRadius(radius - 40);

			var arc = g.selectAll(".arc")
			.data(pie(countryPieData))
			.enter().append("g")
			.attr("class", "arc");

			arc.append("path")
			.attr("d", path)
			.attr("fill", function(d){return color(d.data.label);});

			if(function(d){return d.data.value == 0}){
				console.log("returned true")
				arc.append("text")
				.attr("transform", function(d) { return "translate(" + label.centroid(d) + ")"; })
				.attr("dy", "1em")
				.attr("fill", "black")
				.text(function(d){return d.data.label+" " + d.data.value});
			};

			countrySVG.append("text")
			.attr("x", 110)
			.attr("y", height-15)
			.text("Countries")
			.attr("fill", "white")
			.attr("font-size", "10pt")
			.attr("font-anchor", "middle");		
		}

	</script>

</body>

</html>
